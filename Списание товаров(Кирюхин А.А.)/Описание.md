**Рамки:** Информационная система склада  
**Сценарий:** Списание товаров  
**Уровень:** Задача, определенная пользователем  
**Основной исполнитель:** Кладовщик  

**Заинтересованные лица и их требования**  
Кладовщик:  
- Хочет быстро списать товар из конкретной партии с указанием причины (брак, истечение срока годности, повреждение).  
- Требует мгновенного обновления остатков партии после списания.  
- Нуждается в подтверждении успешной операции с номером документа списания.  
Система учета:  
- Должна получать данные о списании в формате, совместимом с бухгалтерским ПО.  
- Требует передачи артикула, количества, стоимости (рассчитанной по партии), причины списания и номера документа.  

**Предусловия**  
- Пользователь авторизован как Кладовщик.  
- Товар существует в системе и имеет хотя бы одну партию с положительным остатком.  
- Система настроена с перечнем причин списания (брак, просрочка, повреждение).  

**Результаты (Постусловия)**  
- Остатки выбранной партии товара обновлены.  
- Создан документ списания (WriteOff) со статусом APPROVED.  
- Зафиксировано движение товара (StockMovement типа WRITE_OFF) для аудита.  
- Данные о списании переданы в Систему учета.  
- Кладовщик видит номер документа списания, обновленные остатки партии и подтверждение операции.  

**Основной успешный сценарий**  
1. Кладовщик в интерфейсе выбирает раздел «Списание товаров».  
2. Система отображает список партий товаров с указанием срока годности, остатка и причины списания.  
3. Кладовщик выбирает партию, указывает количество и причину списания (выпадающий список).  
4. Система проверяет:  
   - Наличие достаточного количества в выбранной партии.  
   - Корректность причины (для «просрочки» проверяет `ProductBatch.isExpired()`).  
   - Автоматически рассчитывает стоимость списания на основе цены партии.  
5. Система создает документ списания (WriteOff) в статусе DRAFT.  
6. Кладовщик подтверждает операцию нажатием «Подтвердить списание».  
7. Система:  
   - Обновляет остаток партии (`ProductBatch.quantity`), при необходимости разделяет партию через `split()`.  
   - Создает запись движения (`StockMovement` с типом `WRITE_OFF`).  
   - Отправляет данные в Систему учета (артикул, количество, стоимость, причина, номер документа).  
8. Кладовщику отображается уведомление «Списание №[номер] выполнено» и обновленные остатки партии.  

**Расширения (альтернативные потоки)**  
1. **Недостаточно товаров в партии**  
   - Система обнаруживает нехватку остатков в выбранной партии.  
   - Отображается ошибка: «Недостаточно товара в партии. Доступно: [X] единиц».  
   - Кладовщик выбирает другую партию или корректирует количество.  

2. **Ошибка передачи данных в Систему учета**  
   - Система не может отправить данные из-за сетевой ошибки.  
   - Документ списания переводится в статус «Ожидает синхронизации».  
   - Администратор вручную повторяет отправку в разделе «Ожидающие синхронизации».  

**Специальные требования**  
- **Валидация в реальном времени:**  
  - При выборе причины «просрочка» система фильтрует только просроченные партии.  
  - Стоимость списания рассчитывается автоматически на основе цены из `ProductBatch`.  
- **Интеграция с Системой учета:**  
  - Передача данных с шифрованием.  
  - Обязательные поля: артикул, количество, стоимость, причина, номер документа списания, дата операции.  
- **Аудит:**  
  - В логах сохраняются: время операции, пользователь, товар, партия, количество, причина, номер документа списания.  
- **Частичное списание:**  
  - При списании части партии система автоматически создает новую партию через `ProductBatch.split()`.  

**Частота использования**  
- Списание по браку/просрочке: Высокая (ежедневно, среднее количество операций в день).  
- Повторная синхронизация с Системой учета: Низкая (1–2 раза в неделю при ошибках).  

## Открытые вопросы
- Какие поля обязательны для передачи в Систему учета?
- Нужно ли ограничить количество списаний в сутки для одного кладовщика?
- Как обрабатывать частичное списание товара (например, 5 из 10 единиц)?
- Требуется ли подтверждение операции через SMS при списании >100 единиц?
- Какие данные должны храниться в логах для аудита?