![alt text](../assets/spisanie.png)

```
@startuml
actor Кладовщик as Actor
participant UI
participant WarehouseSystemFacade as Facade
participant WriteOff as WriteOffDoc
participant WriteOffItem as WriteOffItem
participant ProductBatch as Batch
participant StockMovement as Movement
participant AccountingSystem as Accounting
participant Database

Actor -> UI: Выбирает "Списание товаров"
activate UI

UI -> Facade: GetAvailableProducts()
activate Facade
Facade -> Database: SELECT * FROM Product
Database --> Facade: List<Product>
Facade --> UI: List<Product>
deactivate Facade

UI --> Actor: Отображает список товаров

Actor -> UI: Выбирает товар, указывает количество и причину
activate UI

UI -> Facade: writeOffGoods(reason, items: List<WriteOffItem>)
activate Facade

Facade -> WriteOffDoc: Create(reason, status=DRAFT)
activate WriteOffDoc
WriteOffDoc -> WriteOffDoc: addItem(product, quantity, reason)
activate WriteOffItem

WriteOffItem -> Batch: FindBatchForWriteOff(product, quantity)
activate Batch
Batch --> WriteOffItem: List<ProductBatch> (отсортированные по сроку годности)
deactivate Batch

WriteOffItem -> WriteOffItem: validateWriteOff() 
alt Проверка успешна
  WriteOffItem --> WriteOffDoc: Добавлено в items
  WriteOffDoc --> Facade: Валидация успешна
else Недостаточно товара
  WriteOffItem --> Facade: Ошибка "Недостаточно товара"
  Facade --> UI: Отображает ошибку
  deactivate Facade
  deactivate UI
  return
end
deactivate WriteOffItem

Facade -> WriteOffDoc: approveWriteOff()
activate WriteOffDoc
WriteOffDoc -> WriteOffDoc: Проверка StockMovement.validateMovement()
WriteOffDoc -> Batch: UpdateBatchQuantity(quantity)
activate Batch
Batch --> Batch: split() или обновление ProductBatch.quantity
Batch --> WriteOffDoc: Успешное обновление
deactivate Batch

WriteOffDoc -> Movement: Create(type=WRITE_OFF, product, quantity)
activate Movement
Movement --> Movement: validateMovement()
Movement --> Database: Сохранить StockMovement
deactivate Movement

WriteOffDoc -> Accounting: SendData(writeOffDocument)
activate Accounting
Accounting --> WriteOffDoc: Подтверждение получения
deactivate Accounting

WriteOffDoc --> WriteOffDoc: status=APPROVED
WriteOffDoc --> Facade: Операция завершена
deactivate WriteOffDoc

Facade -> UI: WriteOffConfirmation
deactivate Facade

UI --> Actor: Отображает подтверждение и обновленные остатки
deactivate UI
@enduml
```