![alt text](../assets/shipment.png)

```
@startuml
actor Кладовщик

participant UI
participant WarehouseSystemFacade
participant GoodsShipment
participant Product
participant StorageLocation
participant ProductBatch
participant StockMovement
participant AccountingSystem
participant Database

Кладовщик-> UI: Выбирает "Регистрация отгрузки"
activate UI

UI -> WarehouseSystemFacade: GetShipmentForm()
activate WarehouseSystemFacade

WarehouseSystemFacade -> GoodsShipment: CreateNewShipment()
activate GoodsShipment
GoodsShipment --> WarehouseSystemFacade: New Shipment object
deactivate GoodsShipment

WarehouseSystemFacade -> UI: Form data
deactivate WarehouseSystemFacade
UI --> Кладовщик: Отображает форму регистрации отгрузки

deactivate UI
Кладовщик -> UI: Вводит данные клиента и накладной
activate UI

UI -> WarehouseSystemFacade: RegisterCustomerInfo(customer: String, invoiceNumber: String)
activate WarehouseSystemFacade

WarehouseSystemFacade -> GoodsShipment: SetCustomerInfo(customer, invoiceNumber)
activate GoodsShipment
GoodsShipment --> WarehouseSystemFacade: Confirmation
deactivate GoodsShipment

WarehouseSystemFacade -> UI: Form updated
deactivate WarehouseSystemFacade
UI --> Кладовщик: Обновленная форма

deactivate UI
Кладовщик-> UI: Добавляет товарные позиции
activate UI

UI -> WarehouseSystemFacade: AddShipmentItems(items: List)
activate WarehouseSystemFacade

loop Для каждого товара
WarehouseSystemFacade -> Product: CheckProductExists(sku: String)
activate Product
Product --> WarehouseSystemFacade: Product info or error
deactivate Product

alt Товар не существует
WarehouseSystemFacade -> UI: Запрос на создание товара
activate UI
UI --> Кладовщик: Форма создания товара
Кладовщик -> UI: Ввод характеристик товара
UI -> WarehouseSystemFacade: CreateNewProduct(data: ProductData)
WarehouseSystemFacade -> Product: CreateProduct(data)
activate Product
Product --> WarehouseSystemFacade: New product created
deactivate Product
end

WarehouseSystemFacade -> ProductBatch: FindAvailableBatches(product: Product, quantity: double)
activate ProductBatch
ProductBatch --> WarehouseSystemFacade: List of available batches
deactivate ProductBatch

WarehouseSystemFacade -> GoodsShipment: AddItem(product, quantity, batch)
activate GoodsShipment
GoodsShipment --> WarehouseSystemFacade: Item added
deactivate GoodsShipment
end

WarehouseSystemFacade -> UI: Confirmation of items added
deactivate WarehouseSystemFacade
UI --> Кладовщик: Подтверждение добавления позиций

deactivate UI
Кладовщик-> UI: Сохраняет отгрузку
activate UI

UI -> WarehouseSystemFacade: ConfirmShipment()
activate WarehouseSystemFacade

WarehouseSystemFacade -> GoodsShipment: ValidateAndConfirm()
activate GoodsShipment
GoodsShipment --> WarehouseSystemFacade: Validation result
deactivate GoodsShipment

alt Проверка успешна
WarehouseSystemFacade -> StockMovement: CreateStockMovement(shipment)
activate StockMovement
StockMovement --> WarehouseSystemFacade: Movement created
deactivate StockMovement

WarehouseSystemFacade -> ProductBatch: UpdateBatches(shipmentItems)
activate ProductBatch
ProductBatch --> WarehouseSystemFacade: Batches updated
deactivate ProductBatch

WarehouseSystemFacade -> StorageLocation: UpdateLocationOccupancy(shipmentItems)
activate StorageLocation
StorageLocation --> WarehouseSystemFacade: Locations updated
deactivate StorageLocation

WarehouseSystemFacade -> AccountingSystem: SendShipmentData(shipment)
activate AccountingSystem
AccountingSystem --> WarehouseSystemFacade: Confirmation
deactivate AccountingSystem

WarehouseSystemFacade -> Database: SaveShipment(shipment)
activate Database
Database --> WarehouseSystemFacade: Shipment saved
deactivate Database
else Ошибка проверки
WarehouseSystemFacade --> UI: Error details
deactivate WarehouseSystemFacade
UI --> Кладовщик: Показывает ошибки
deactivate UI
return
end

WarehouseSystemFacade -> UI: Shipment confirmation
deactivate WarehouseSystemFacade
UI --> Кладовщик: Показывает информацию об отгрузке

deactivate UI
@enduml
```