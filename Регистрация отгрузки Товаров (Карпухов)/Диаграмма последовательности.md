![alt text](../assets/shipment.png)

```
@startuml
actor "Кладовщик" as Clerk
participant "WarehouseController" as Controller
participant "WarehouseFacade" as Facade
participant "RegisterGoodsShipmentUseCase" as ShipmentUseCase
participant "InventoryService" as InventoryService
participant "ShipmentRepository" as ShipmentRepo
participant "MovementService" as MovementService

Clerk -> Controller: shipGoods(ShipmentDto)
Controller -> Facade: shipGoods(command: ShipmentCommand)
Facade -> ShipmentUseCase: execute(command: ShipmentCommand)

loop for each item in command.items
    ShipmentUseCase -> InventoryService: getCurrentStock(item.productId)
    InventoryService --> ShipmentUseCase: stockLevel
    alt if stockLevel >= item.quantity
        ... proceed ...
    else
        ShipmentUseCase --> Facade: Result<Error>
        Facade --> Controller: error response
        Controller --> Clerk: error notification
        return
    end
end

ShipmentUseCase -> ShipmentRepo: nextIdentity()
ShipmentRepo --> ShipmentUseCase: shipmentId

ShipmentUseCase -> ShipmentRepo: save(shipmentDocument)
ShipmentRepo --> ShipmentUseCase: success

loop for each item in command.items
    ShipmentUseCase -> MovementService: recordShipmentMovement(\nitem.productId,\nitem.quantity,\nitem.locationId\n)
    MovementService -> MovementService: validateMovement()
    MovementService -> MovementService: publish(MovementRecordedEvent)
    MovementService --> ShipmentUseCase: movementId
end

ShipmentUseCase --> Facade: Result<ShipmentId>
Facade --> Controller: shipmentId
Controller --> Clerk: success response

@enduml
```